<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <title>AR Visiting Card</title>
  <link rel="stylesheet" href="style.css" />
  <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
</head>
<body>
  <h2>AR Visiting Card</h2>
  <p id="status">Loading data...</p>

  <!-- Fallback message for non-mobile -->
  <div id="fallback" style="display: none; color: red;">
    ❌ AR not supported on this device. Please open on a mobile device.
  </div>

  <!-- Contact Details Display -->
  <div id="details">
    <p><strong>Name:</strong> <span id="name">Loading...</span></p>
    <p><strong>Address:</strong> <span id="address">Loading...</span></p>
    <p><strong>Email:</strong> <span id="email">Loading...</span></p>
    <p><strong>Contact Number:</strong> <span id="contact">Loading...</span></p>
  </div>

  <!-- AR Scene -->
  <!-- Add to <a-scene> -->
<a-scene
vr-mode-ui="enabled: false"
embedded
renderer="colorManagement: true; physicallyCorrectLights: true"
webxr="optionalFeatures: hit-test;"
cursor="rayOrigin: mouse"
>
<!-- Lights -->
<a-light type="ambient" intensity="1"></a-light>
<a-light type="directional" intensity="1" position="0 2 1"></a-light>

<!-- Hit-test placement logic -->
<a-entity id="reticle" visible="false" geometry="primitive: ring; radiusInner: 0.05; radiusOuter: 0.08;"
          material="color: green; shader: flat" position="0 0 -1" rotation="-90 0 0">
</a-entity>

<!-- Your AR object -->
<a-box id="arBox" visible="false" color="red" depth="0.2" height="0.2" width="0.2"></a-box>
<a-text id="arText" value="AR Details" visible="false" position="-0.5 0.25 -1" scale="0.3 0.3 0.3" color="white"></a-text>
</a-scene>


  <script>
    const status = document.getElementById("status");
    const isMobile = /Mobi|Android/i.test(navigator.userAgent);
    const fallback = document.getElementById("fallback");

    // Show fallback on desktop
    if (!isMobile) {
      fallback.style.display = "block";
      document.querySelector("a-scene").style.display = "none";
    }

    // Fetch Contact Details from Google Sheet
    async function fetchData() {
      status.innerText = "Fetching data from Google Sheet...";
      const sheetID = "1cFt2ab4Q757yySBB0CqxjYLnXGdqp0_EzXzfnScFWXs";
      const url = `https://docs.google.com/spreadsheets/d/${sheetID}/gviz/tq?tqx=out:json`;

      try {
        let response = await fetch(url);
        if (!response.ok) throw new Error(`HTTP error: ${response.status}`);
        let text = await response.text();
        let jsonData = JSON.parse(text.substring(47, text.length - 2));
        let rows = jsonData.table.rows[0].c;

        const details = {
          name: rows[0]?.v || "N/A",
          address: rows[1]?.v || "N/A",
          email: rows[2]?.v || "N/A",
          contact: rows[3]?.v || "N/A",
        };

        document.getElementById("name").innerText = details.name;
        document.getElementById("address").innerText = details.address;
        document.getElementById("email").innerText = details.email;
        document.getElementById("contact").innerText = details.contact;

        const arText = `Name: ${details.name}\nAddress: ${details.address}\nEmail: ${details.email}\nContact: ${details.contact}`;
        document.getElementById("contactDetails").setAttribute("value", arText);

        status.innerText = "✅ AR Experience Ready";
      } catch (error) {
        console.error("Error fetching data:", error);
        status.innerText = "❌ Failed to load data.";
      }
    }

    window.onload = async function () {
      await fetchData();
    };

        AFRAME.registerComponent('ar-hit-test', {
          init: function () {
            const sceneEl = this.el.sceneEl;
            const arBox = document.querySelector("#arBox");
            const arText = document.querySelector("#arText");
            const reticle = document.querySelector("#reticle");
      
            this.el.sceneEl.addEventListener('enter-vr', () => {
              if (sceneEl.renderer.xr.getSession()) {
                const viewerSpace = sceneEl.renderer.xr.getReferenceSpace();
                const hitTestSource = sceneEl.renderer.xr.getSession().requestReferenceSpace('viewer')
                  .then(refSpace => {
                    return sceneEl.renderer.xr.getSession().requestHitTestSource({ space: refSpace });
                  });
      
                sceneEl.renderer.xr.getSession().addEventListener('select', () => {
                  if (reticle.getAttribute('visible')) {
                    const position = reticle.object3D.position;
                    arBox.setAttribute('visible', true);
                    arBox.setAttribute('position', position);
                    arText.setAttribute('visible', true);
                    arText.setAttribute('position', { x: position.x - 0.5, y: position.y + 0.25, z: position.z });
                  }
                });
      
                sceneEl.renderer.setAnimationLoop((time, frame) => {
                  if (!frame) return;
      
                  const referenceSpace = sceneEl.renderer.xr.getReferenceSpace();
                  hitTestSource.then(source => {
                    const hitTestResults = frame.getHitTestResults(source);
                    if (hitTestResults.length > 0) {
                      const hit = hitTestResults[0];
                      const pose = hit.getPose(referenceSpace);
      
                      reticle.setAttribute('visible', true);
                      reticle.object3D.position.set(pose.transform.position.x, pose.transform.position.y, pose.transform.position.z);
                      reticle.object3D.quaternion.set(
                        pose.transform.orientation.x,
                        pose.transform.orientation.y,
                        pose.transform.orientation.z,
                        pose.transform.orientation.w
                      );
                    }
                  });
                });
              }
            });
          }
        });
      
        document.querySelector("a-scene").setAttribute("ar-hit-test", "");

      
  </script>
</body>
</html>
